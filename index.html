<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ù…Ù†ØµÙ‘Ø© Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù…Ø¯Ø±Ù‘Ø¨ÙŠÙ† â€” Ù…Ù„Ù ÙˆØ§Ø­Ø¯</title>
<meta name="theme-color" content="#0ea5e9">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b1220;--card:#121a2b;--panel:#0f1728;--border:#1e2a44;--text:#e6eaf2;--muted:#9aa7bd;
  --brand:#0ea5e9;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:"Cairo",system-ui; background:linear-gradient(180deg,#0a0f1a,#0b1220 60%); color:var(--text)}
a{color:var(--brand);text-decoration:none}
.container{max-width:1100px;margin:auto;padding:0 16px}
.header{position:sticky;top:0;z-index:5;background:rgba(18,26,43,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
.nav{height:64px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:10px;font-weight:700}
.badge{border:1px solid var(--border);border-radius:999px;padding:2px 10px;color:var(--muted);font-size:12px}
.btn{background:var(--brand);color:#001017;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn-outline{background:transparent;color:var(--text);border:1px solid var(--border)}
.btn-danger{background:var(--bad);color:#fff}
.grid{display:grid;gap:12px}
.grid-2{grid-template-columns:320px 1fr}
@media(max-width:1000px){.grid-2{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
.small{color:var(--muted);font-size:.95rem}
.hero{padding:20px 0;border-bottom:1px solid var(--border)}
.hero h1{margin:0 0 6px;font-size:26px}
.hero p{margin:0;color:var(--muted)}
.controls{display:flex;gap:8px;flex-wrap:wrap}
label{display:flex;gap:8px;align-items:center}
select,textarea,input[type="text"],input[type="email"],input[type="password"]{
  width:100%;background:var(--panel);border:1px solid var(--border);border-radius:10px;color:var(--text);padding:10px;font-family:inherit
}
.stage{position:relative;height:420px;border:1px solid var(--border);border-radius:16px;background:radial-gradient(1000px 380px at 50% 110%,#0b1220 40%,#0f1728 100%);overflow:hidden}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.kpi{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:8px}
.kpi h4{margin:0 0 6px;font-size:12px;color:var(--muted)}
.kpi .num{font-weight:700}
.avatar{position:absolute;bottom:0;width:210px;height:300px;background:#152039;border:1px solid var(--border);border-radius:16px 16px 0 0;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;transition:filter .2s}
.avatar .face{width:96px;height:96px;background:#f0c7a8;border-radius:60% 60% 50% 50%}
.avatar .eyes{display:flex;gap:16px;transform:translateY(-28px)}
.eye{width:10px;height:10px;background:#111;border-radius:50%}
.avatar .mouth{width:42px;height:12px;background:#991b1b;border-radius:0 0 24px 24px;transform:translateY(-22px);transition:height .08s}
.avatar .body{width:150px;height:120px;background:#1f2a44;border-radius:12px 12px 0 0;margin-top:-6px}
.avatar .name{position:absolute;top:8px;right:8px;background:#0b1220;border:1px solid var(--border);font-size:12px;padding:2px 6px;border-radius:999px;color:var(--muted)}
.avatar .bubble{position:absolute;bottom:310px;right:10px;max-width:240px;background:#0b1220;border:1px solid var(--border);color:var(--text);padding:8px;border-radius:10px;display:none}
.avatar.show .bubble{display:block}
.avatar.talking{filter:drop-shadow(0 0 12px rgba(34,197,94,.4))}
.avatar.talking .mouth{height:28px}
.avatar:nth-child(1){left:12px}
.avatar:nth-child(2){left:calc(12px + 220px)}
.avatar:nth-child(3){left:calc(12px + 220px*2)}
.avatar:nth-child(4){left:calc(12px + 220px*3)}
.chat{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:8px;display:flex;flex-direction:column;gap:6px;height:170px}
.chat-log{flex:1;overflow:auto;display:flex;flex-direction:column;gap:6px}
.msg{padding:6px 8px;border-radius:12px;max-width:85%}
.msg.me{background:var(--brand);color:#001017;align-self:flex-start}
.msg.ai{background:#101a30;border:1px solid var(--border);align-self:flex-end}
.toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#0f1728;border:1px solid var(--border);border-radius:12px;padding:8px 10px;display:none}
.toast.show{display:block}
footer{color:var(--muted);text-align:center;padding:16px}
</style>
</head>
<body>
<header class="header">
  <div class="container nav">
    <div class="brand">ğŸ™ï¸ Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù…Ø¯Ø±Ù‘Ø¨ <span class="badge">Ù…Ù„Ù ÙˆØ§Ø­Ø¯</span></div>
    <div class="controls">
      <button class="btn-outline" id="downloadReport" disabled>ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
      <button class="btn" id="startSim">Ø§Ø¨Ø¯Ø£</button>
      <button class="btn-danger" id="stopSim" disabled>Ø¥Ù†Ù‡Ø§Ø¡</button>
    </div>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h1>Ø¬Ù„Ø³Ø© Ù…Ø­Ø§ÙƒØ§Ø© Ù‚ØµÙŠØ±Ø© Ø¨Ù„Ù‡Ø¬Ø© Ø³Ø¹ÙˆØ¯ÙŠØ© (ØµÙˆØª/Ù†Øµ + ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©)</h1>
    <p>ÙŠØªÙ… Ù‚ÙŠØ§Ø³ Ø§Ù„Ø³Ø±Ø¹Ø© ÙˆØ§Ù„Ù†Ø¨Ø±Ø© ÙˆØ§Ù„ØµÙ…Øª ÙˆØ§Ù„Ù…Ù‚Ø§Ø·Ø¹Ø§Øª ÙˆØ§ØªØµØ§Ù„Ùƒ Ø§Ù„Ø¨ØµØ±ÙŠ. Ø¨Ø¹Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø©ØŒ ÙŠÙ†ÙˆÙ„Ø¯ ØªÙ‚Ø±ÙŠØ± PDF.</p>
  </div>
</section>

<div class="container grid grid-2" style="padding:12px 0 18px">
  <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
  <aside class="card">
    <h3>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
    <label><input id="micOn" type="checkbox" checked> ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø§ÙŠÙƒ</label>
    <label><input id="camOn" type="checkbox"> ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</label>
    <label><input id="liveHints" type="checkbox" checked> Ù…Ø¤Ø´Ø±Ø§Øª Ù„Ø­Ø¸ÙŠØ©</label>
    <div style="height:8px"></div>
    <label>Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ</label>
    <select id="scenarioSel"></select>
    <div style="height:8px"></div>
    <label>Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ø·Ù„Ø§Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
    <input id="note" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„ÙŠÙˆÙ… Ù†ØºØ·ÙŠ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª + Ù…Ø«Ø§Ù„ Ø¹Ù…Ù„ÙŠ">
    <div style="height:8px"></div>
    <h3>Ø¯Ø®ÙˆÙ„</h3>
    <input id="email" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
    <input id="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
    <button class="btn-outline" id="fakeLogin">Ø¯Ø®ÙˆÙ„ Ø¶ÙŠÙ</button>
    <p class="small">Ù„Ù„ØªØ¬Ø±ÙŠØ¨ ÙÙ‚Ø· â€” Ù„Ø§ ØªØ­ØªØ§Ø¬ Ø¥Ø¹Ø¯Ø§Ø¯ Firebase Ø§Ù„Ø¢Ù†.</p>
  </aside>

  <!-- Ø§Ù„Ù…Ø³Ø±Ø­ -->
  <main class="card">
    <div class="kpis">
      <div class="kpi"><h4>Ø§Ù„ÙˆÙ‚Øª</h4><div class="num" id="clock">00:00</div></div>
      <div class="kpi"><h4>Ø§Ù„Ø³Ø±Ø¹Ø© (WPM)</h4><div class="num" id="wpm">0</div></div>
      <div class="kpi"><h4>Ø§Ù„ØµÙˆØª (RMS)</h4><div class="num" id="rms">0</div></div>
      <div class="kpi"><h4>Ø§Ù„Ø·Ø¨Ù‚Ø© (Hz)</h4><div class="num" id="pitch">â€”</div></div>
      <div class="kpi"><h4>Ø§Ù„ØµÙ…Øª %</h4><div class="num" id="silence">â€”</div></div>
      <div class="kpi"><h4>Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹Ø§Øª</h4><div class="num" id="intr">0</div></div>
      <div class="kpi"><h4>Ø§ØªØµØ§Ù„ Ø¨ØµØ±ÙŠ</h4><div class="num" id="eye">â€”</div></div>
      <div class="kpi"><h4>Ø¥ÙŠÙ…Ø§Ø¡Ø§Øª/Ø¯Ù‚ÙŠÙ‚Ø©</h4><div class="num" id="gest">â€”</div></div>
    </div>

    <div class="stage" id="stage" aria-live="polite"></div>

    <div class="grid" style="grid-template-columns: 260px 1fr; align-items: start; margin-top:10px">
      <video id="camView" autoplay playsinline muted style="width:260px;height:180px;border-radius:12px;border:1px solid var(--border);display:none"></video>
      <div class="chat">
        <div class="chat-log" id="chatLog"></div>
        <div style="display:flex;gap:8px">
          <input id="chatInput" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ù‘Ùƒ Ù‡Ù†Ø§â€¦ Ø«Ù… Enter">
          <button class="btn" id="sendChat">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>
      </div>
    </div>
  </main>
</div>

<section class="container">
  <div class="card">
    <h3>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡</h3>
    <div class="grid" style="grid-template-columns: repeat(3,1fr)">
      <div><div class="small">Ù…ØªÙˆØ³Ø· WPM</div><div id="repWpm" style="font-weight:700;font-size:20px">â€”</div></div>
      <div><div class="small">Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹Ø§Øª</div><div id="repIntr" style="font-weight:700;font-size:20px">â€”</div></div>
      <div><div class="small">Ø§ØªØµØ§Ù„ Ø¨ØµØ±ÙŠ</div><div id="repEye" style="font-weight:700;font-size:20px">â€”</div></div>
    </div>
    <div style="height:8px"></div>
    <h4>Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©</h4><ul id="repStrengths"></ul>
    <h4>Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ­Ø³ÙŠÙ†</h4><ul id="repImprovements"></ul>
    <h4>ØªÙˆØµÙŠØ§Øª Ù…ÙˆØ¬Ù‘Ù‡Ø©</h4><ul id="repTips"></ul>
  </div>
</section>

<div class="toast" id="toast"></div>

<!-- jsPDF Ù„ØªÙˆÙ„ÙŠØ¯ PDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/* ===========================
   Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª
   =========================== */
const SCENARIOS = {
  "Ù…Ø­Ø§Ø¶Ø±Ø© Ù†Ø¸Ø±ÙŠØ© â€” Ø£Ø³Ø§Ø³ÙŠØ§Øª": {
    durationMin: 12,
    students: [
      {id:"s1", role:"Ù…Ø´Ø§ØºØ¨", name:"Ø³Ù„Ù…Ø§Ù†", openers:["Ù„ÙŠÙ‡ Ù†Ø­ØªØ§Ø¬ Ø°Ø§ ÙƒÙ„Ù‡ØŸ","Ø·ÙŠØ¨ Ø¹Ø·Ù†Ø§ Ù…Ø«Ø§Ù„ Ø­ÙŠØ§ØªÙŠ Ø³Ø±ÙŠØ¹ØŸ"]},
      {id:"s2", role:"ÙØ¶ÙˆÙ„ÙŠ", name:"Ù„ÙŠØ§Ù†", openers:["Ù…Ù…ÙƒÙ† ØªØ¨Ø³Ù‘Ø· Ø§Ù„Ù…ØµØ·Ù„Ø­ØŸ","ÙˆØ´ Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ù…ØªÙˆØ³Ø· ÙˆØ§Ù„ÙˆØ³ÙŠØ·ØŸ"]},
      {id:"s3", role:"Ø®Ø¬ÙˆÙ„", name:"ÙÙ‡Ø¯", openers:["Ù…Ù…ÙƒÙ† Ø£ÙƒØªØ¨ Ø¨Ø§Ù„Ø´Ø§ØªØŸ","Ù…Ø§Ù†ÙŠ Ù…ØªØ£ÙƒØ¯ Ø¨Ø³ Ø£Ø¸Ù†â€¦"]},
      {id:"s4", role:"Ù…Ù†Ø´ØºÙ„", name:"Ù†ÙˆØ±Ø©", openers:["Ø¢Ø³ÙØ© ÙƒÙ†Øª Ø¨Ø§Ù„Ø¬ÙˆØ§Ù„.. ÙˆÙŠÙ† ÙˆØµÙ„Ù†Ø§ØŸ","ÙÙŠ Ù†Ù‚Ø§Ø· Ù…Ù‡Ù…Ù‘Ø© Ø£Ø¯ÙˆÙ†Ù‡Ø§ØŸ"]}
    ]
  },
  "Ù†Ø´Ø§Ø· Ø¹Ù…Ù„ÙŠ â€” Ù…Ø®ØªØ¨Ø±": {
    durationMin: 10,
    students: [
      {id:"g1", role:"Ù‚Ø§Ø¦Ø¯", name:"ØªØ±ÙƒÙŠ", openers:["Ù†Ù‚Ø³Ù… Ø§Ù„Ù…Ù‡Ø§Ù…ØŸ","Ø£Ù‚ØªØ±Ø­ Ù†Ø­Ø¯Ø¯ Ù‡Ø¯Ù ÙˆØ§Ø¶Ø­ Ù„Ù„Ù€10 Ø¯Ù‚Ø§ÙŠÙ‚ Ø§Ù„Ø¬Ø§ÙŠØ©"]},
      {id:"g2", role:"Ù…ØªØ­ÙÙ‘Ø¸", name:"Ø´Ù‡Ø¯", openers:["Ù†Ø¬Ø±Ø¨ Ø·Ø±ÙŠÙ‚Ø© Ø«Ø§Ù†ÙŠØ©ØŸ","Ø£Ø®Ø§Ù Ø§Ù„ÙˆÙ‚Øª Ù…Ø§ ÙŠÙƒÙÙŠ"]},
      {id:"g3", role:"Ù…Ù‚Ø§Ø·Ø¹", name:"ÙŠØ²ÙŠØ¯", openers:["Ù„Ø­Ø¸Ø© ØªØµØ­ÙŠØ­ Ø¨Ø³ÙŠØ·","Ø®Ù„Ù‘Ù†ÙŠ Ø£ÙˆØ¶Ø­ Ù†Ù‚Ø·Ø©"]}
    ]
  }
};

/* ========== DOM ========== */
const stage = document.getElementById('stage');
const scenarioSel = document.getElementById('scenarioSel');
const micOn = document.getElementById('micOn');
const camOn = document.getElementById('camOn');
const liveHints = document.getElementById('liveHints');
const startBtn = document.getElementById('startSim');
const stopBtn = document.getElementById('stopSim');
const downloadBtn = document.getElementById('downloadReport');
const clockEl = document.getElementById('clock');
const wpmEl = document.getElementById('wpm');
const rmsEl = document.getElementById('rms');
const pitchEl = document.getElementById('pitch');
const silenceEl = document.getElementById('silence');
const intrEl = document.getElementById('intr');
const eyeEl = document.getElementById('eye');
const gestEl = document.getElementById('gest');
const camView = document.getElementById('camView');
const chatLog = document.getElementById('chatLog');
const chatInput = document.getElementById('chatInput');
const sendChat = document.getElementById('sendChat');
const toast = document.getElementById('toast');
const repWpm = document.getElementById('repWpm');
const repIntr = document.getElementById('repIntr');
const repEye = document.getElementById('repEye');
const repStrengths = document.getElementById('repStrengths');
const repImprovements = document.getElementById('repImprovements');
const repTips = document.getElementById('repTips');

/* ========== Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ù„Ø³Ø© ========== */
let currentScenario = null;
let running = false, startTime = 0, timerInterval = null;
let wordsSpoken = 0, interruptions = 0, lastStudentEnd = Date.now();
let recognizer = null;
let micStream = null, camStream = null, audioCtx = null, analyser = null, sourceNode = null;
let pitchHz = null, rmsLevel = 0, silenceRatio = 0, silenceSamples = 0, totalSamples = 0;
let eyeContactArr = [], gesturesCount = 0, lastGestureMag = 0;
let faceDetector = ('FaceDetector' in window) ? new FaceDetector({fastMode:true}) : null;

/* ========== Ø£Ø¯ÙˆØ§Øª ========== */
const showToast = (m)=>{ toast.textContent=m; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1800); };
const rand = (a)=>a[Math.floor(Math.random()*a.length)];
const fmtTime = (ms)=>{ const s=Math.floor(ms/1000); const m=String(Math.floor(s/60)).padStart(2,'0'); const r=String(s%60).padStart(2,'0'); return m+':'+r; };

/* ========== Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø³Ø±Ø­ ========== */
function loadScenarios(){
  Object.keys(SCENARIOS).forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; scenarioSel.appendChild(o); });
  scenarioSel.value=Object.keys(SCENARIOS)[0];
  setScenario(scenarioSel.value);
}
function setScenario(name){
  currentScenario = JSON.parse(JSON.stringify(SCENARIOS[name]));
  stage.innerHTML='';
  (currentScenario.students||[]).slice(0,4).forEach((s,i)=>{
    const v=document.createElement('div'); v.className='avatar'; v.dataset.sid=s.id;
    v.innerHTML = `
      <div class="name">${s.name} â€” ${s.role}</div>
      <div class="bubble" id="bubble-${s.id}"></div>
      <div class="face"></div>
      <div class="eyes"><div class="eye"></div><div class="eye"></div></div>
      <div class="mouth"></div>
      <div class="body"></div>
    `;
    stage.appendChild(v);
  });
}
scenarioSel.onchange = ()=>setScenario(scenarioSel.value);

/* ========== Ø¯Ø±Ø¯Ø´Ø© ========== */
function logChat(sender, text, who='me'){
  const div=document.createElement('div');
  div.className = 'msg '+(who==='me'?'me':'ai');
  div.textContent = sender?`${sender}: ${text}`:text;
  chatLog.appendChild(div);
  chatLog.scrollTop = chatLog.scrollHeight;
}
sendChat.onclick = ()=>sendChatMsg();
chatInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter') sendChatMsg(); });
function sendChatMsg(){
  const t=chatInput.value.trim(); if(!t) return;
  logChat('Ø§Ù„Ù…Ø¯Ø±Ù‘Ø¨', t, 'me');
  wordsSpoken += t.split(/\s+/).length;
  wpmEl.textContent = Math.round(wordsSpoken / Math.max(0.1,(Date.now()-startTime)/60000));
  scheduleStudentResponse(t);
  chatInput.value='';
}

/* ========== ØµÙˆØª: Ø§Ù„ØªØ¹Ø±Ù + ØªØ­Ù„ÙŠÙ„ ========= */
function setupRecognition(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR || !micOn.checked){ recognizer=null; return; }
  recognizer = new SR();
  recognizer.lang = 'ar-SA';
  recognizer.continuous = true;
  recognizer.interimResults = true;
  recognizer.onresult = (e)=>{
    let finalText='';
    for(let i=e.resultIndex;i<e.results.length;i++){
      const r = e.results[i];
      if(r.isFinal) finalText += r[0].transcript + ' ';
    }
    if(finalText.trim()){
      logChat('Ø§Ù„Ù…Ø¯Ø±Ù‘Ø¨', finalText.trim(), 'me');
      const wc = finalText.trim().split(/\s+/).length;
      wordsSpoken += wc;
      const wpm = Math.round(wordsSpoken / Math.max(0.1,(Date.now()-startTime)/60000));
      wpmEl.textContent = wpm;
      if(liveHints.checked){
        if(wpm>160) showToast('âš ï¸ Ø³Ø±Ø¹Ù€ØªÙƒ Ø¹Ø§Ù„ÙŠØ© â€” Ø®ÙÙ‘Ù Ø§Ù„ÙˆØªÙŠØ±Ø©.');
        if(wpm<90) showToast('ğŸ”ˆ Ø­Ø§ÙˆÙ„ ØªØ±ÙØ¹ Ø§Ù„ÙˆØªÙŠØ±Ø© Ù‚Ù„ÙŠÙ„Ù‹Ø§.');
      }
      maybeInterrupt();
      scheduleStudentResponse(finalText.trim());
    }
  };
}
async function setupMicAnalyser(){
  if(!micOn.checked) return;
  try{
    micStream = await navigator.mediaDevices.getUserMedia({audio:true});
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    sourceNode = audioCtx.createMediaStreamSource(micStream);
    analyser = audioCtx.createAnalyser(); analyser.fftSize = 2048;
    sourceNode.connect(analyser);
    const buf = new Float32Array(analyser.fftSize);
    const tick = ()=>{
      if(!running) return;
      analyser.getFloatTimeDomainData(buf);
      // RMS
      let sum=0; for(let i=0;i<buf.length;i++){ sum += buf[i]*buf[i]; }
      const rms = Math.sqrt(sum/buf.length);
      rmsLevel = Math.round(rms*1000)/10; // 0..~70
      rmsEl.textContent = rmsLevel.toFixed(1);
      // Silence (threshold)
      const isSilent = rms < 0.02;
      totalSamples++; if(isSilent) silenceSamples++;
      silenceRatio = Math.round(100*silenceSamples/totalSamples);
      silenceEl.textContent = silenceRatio+'%';
      // Pitch via autocorrelation (Ø¨Ø³ÙŠØ·Ø©)
      pitchHz = estimatePitch(buf, audioCtx.sampleRate);
      pitchEl.textContent = pitchHz? Math.round(pitchHz) : 'â€”';
      if(liveHints.checked){
        if(rmsLevel<8) showToast('ğŸ”Š Ø§Ø±ÙØ¹ Ø§Ù„ØµÙˆØª Ù‚Ù„ÙŠÙ„Ù‹Ø§.');
        if(rmsLevel>45) showToast('ğŸ”‰ Ø®ÙÙ‘Ø¶ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª.');
      }
      requestAnimationFrame(tick);
    };
    requestAnimationFrame(tick);
  }catch(e){ console.warn(e); showToast('ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø§ÙŠÙƒ'); }
}
function estimatePitch(buf, sr){
  // Autocorrelation
  let SIZE = buf.length;
  let bestOffset=-1, bestCorr=0, rms=0;
  for(let i=0;i<SIZE;i++) rms += buf[i]*buf[i];
  rms = Math.sqrt(rms/SIZE);
  if(rms<0.01) return null;
  let lastCorr=1;
  for(let offset=32; offset<512; offset++){
    let corr=0;
    for(let i=0; i<SIZE-offset; i++) corr += buf[i]*buf[i+offset];
    corr = corr/(SIZE-offset);
    if(corr>0.9 && corr>lastCorr){ bestCorr=corr; bestOffset=offset; }
    lastCorr=corr;
  }
  if(bestOffset>0) return sr/bestOffset;
  return null;
}

/* ========== Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø·Ù„Ø§Ø¨ (Ù‚ÙˆØ§Ø¹Ø¯ Ø¨Ø³ÙŠØ·Ø©) ========== */
function scheduleStudentResponse(txt){
  const sList = currentScenario.students;
  let target = rand(sList);
  if(/[Ù„ÙŠØ´|Ù„ÙŠÙ‡|ÙˆØ´ Ø§Ù„ÙØ§ÙŠØ¯Ø©]/.test(txt)) target = sList.find(s=>s.role.includes('Ù…Ø´Ø§ØºØ¨')) || target;
  if(/ÙˆØ¶Ø­|Ù…Ù…ÙƒÙ†|ÙŠØ¹Ù†ÙŠ|ÙˆØ´ Ø§Ù„ÙØ±Ù‚/.test(txt)) target = sList.find(s=>s.role.includes('ÙØ¶ÙˆÙ„ÙŠ')) || target;
  const say = target.openers ? rand(target.openers) : "ØªÙ…Ø§Ù…ØŸ Ù†ÙƒÙ…Ù„ØŸ";
  setTimeout(()=>studentSpeak(target, say), 700 + Math.random()*800);
}
function studentSpeak(stu, text){
  lastStudentEnd = Date.now();
  const av=[...stage.querySelectorAll('.avatar')].find(a=>a.dataset.sid===stu.id);
  if(!av) return;
  av.classList.add('talking','show');
  av.querySelector('.bubble').textContent = text;
  // ØµÙˆØª (Ø¥Ù† ØªÙˆÙØ±)
  if('speechSynthesis' in window){
    const u = new SpeechSynthesisUtterance(text); u.lang='ar-SA'; u.rate=1.02; speechSynthesis.speak(u);
    u.onend=()=> av.classList.remove('talking');
  }else{
    setTimeout(()=>av.classList.remove('talking'), Math.min(2400, text.length*70));
  }
  logChat(`${stu.name} (${stu.role})`, text, 'ai');
}
function maybeInterrupt(){
  // Ø¥Ø°Ø§ Ø±Ø¯Ù‘ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø®Ù„Ø§Ù„ 1.6Ø« Ù…Ù† ÙƒÙ„Ø§Ù… Ø§Ù„Ù…Ø¯Ø±Ù‘Ø¨ Ù†Ø¹Ø¯Ù‡Ø§ Ù…Ù‚Ø§Ø·Ø¹Ø©
  if(Date.now()-lastStudentEnd < 1600){
    interruptions++; intrEl.textContent = interruptions;
    if(liveHints.checked) showToast('âš ï¸ ÙÙŠ Ù…Ù‚Ø§Ø·Ø¹Ø©: Ø«Ø¨Ù‘Øª Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© "Ù†ÙƒÙ…Ù‘Ù„ Ø§Ù„ÙÙƒØ±Ø© Ø«Ù… Ù†Ø±Ø¯".');
  }
}

/* ========== ÙƒØ§Ù…ÙŠØ±Ø§ + ØªÙ‚Ø¯ÙŠØ± Ø¨ØµØ±ÙŠ Ø¨Ø³ÙŠØ· ========== */
async function setupCam(){
  if(!camOn.checked){ camView.style.display='none'; return; }
  try{
    camStream = await navigator.mediaDevices.getUserMedia({video:true, audio:false});
    camView.srcObject = camStream; camView.style.display='block';
    if(faceDetector){
      const detect = async ()=>{
        if(!running) return;
        try{
          const faces = await faceDetector.detect(camView);
          if(faces.length>0){
            const box = faces[0].boundingBox;
            const vw = camView.videoWidth||320;
            const cx = box.x + box.width/2;
            const centered = (cx>vw*0.35 && cx<vw*0.65);
            eyeContactArr.push(centered?1:0);
            eyeEl.textContent = centered? 'Ø¬ÙŠØ¯ âœ…' : 'Ø¶Ø¹ÙŠÙ âš ï¸';
          }else{
            eyeContactArr.push(0); eyeEl.textContent='ØºÙŠØ± Ù…ØªØ§Ø­';
          }
        }catch(e){ eyeEl.textContent='â€”'; }
        setTimeout(detect, 900);
      };
      detect();
    }else{
      eyeEl.textContent = 'FaceDetector ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…';
    }
    // ØªÙ‚Ø¯ÙŠØ± "Ø­Ø±ÙƒØ©/Ø¥ÙŠÙ…Ø§Ø¡Ø§Øª" Ø¹Ø¨Ø± Ø§Ù„ØªØ°Ø¨Ø°Ø¨ Ø§Ù„Ø¨Ø³ÙŠØ· ÙÙŠ luminance (ØªÙ‚Ø±ÙŠØ¨ÙŠ)
    const canvas=document.createElement('canvas'); const ctx=canvas.getContext('2d');
    let lastVal=0, moves=0, startT=Date.now();
    const sample=()=>{
      if(!running || !camView.videoWidth) return;
      canvas.width=64; canvas.height=36;
      ctx.drawImage(camView,0,0,64,36);
      const d = ctx.getImageData(0,0,64,36).data;
      let s=0; for(let i=0;i<d.length;i+=4){ s += (0.2126*d[i]+0.7152*d[i+1]+0.0722*d[i+2]); }
      const avg = s/(d.length/4);
      const delta = Math.abs(avg-lastVal); lastVal=avg;
      if(delta>3) moves++;
      const mins = Math.max(0.001,(Date.now()-startT)/60000);
      gestEl.textContent = Math.round(moves/mins);
      requestAnimationFrame(sample);
    };
    requestAnimationFrame(sample);
  }catch(e){ console.warn(e); showToast('ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§'); }
}

/* ========== Ù…Ø¤Ù‚Ù‘Øª ========== */
function startTimer(){
  startTime = Date.now();
  timerInterval = setInterval(()=>{
    const elapsed = Date.now()-startTime;
    clockEl.textContent = fmtTime(elapsed);
    const target = (currentScenario?.durationMin||12)*60*1000;
    if(elapsed>target && liveHints.checked) showToast('âŒ› Ù‚Ø§Ø±Ø¨Ù†Ø§ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­ â€” Ù„Ø®Øµ Ø§Ù„Ù†Ù‚Ø§Ø·.');
  }, 250);
}
function stopTimer(){ clearInterval(timerInterval); timerInterval=null; }

/* ========== Ø¨Ø¯Ø¡/Ø¥ÙŠÙ‚Ø§Ù ========== */
async function startSim(){
  if(running) return;
  running=true;
  startBtn.disabled=true; stopBtn.disabled=false; downloadBtn.disabled=true;
  // reset
  wordsSpoken=0; interruptions=0; lastStudentEnd=Date.now();
  wpmEl.textContent='0'; intrEl.textContent='0'; rmsEl.textContent='0'; pitchEl.textContent='â€”'; silenceEl.textContent='â€”'; eyeEl.textContent='â€”'; gestEl.textContent='â€”';
  silenceSamples=0; totalSamples=0; eyeContactArr=[];
  // stage openers
  currentScenario.students.slice(0,4).forEach((s,i)=>setTimeout(()=>studentSpeak(s, rand(s.openers||["Ø¬Ø§Ù‡Ø²ÙŠÙ†ØŸ"])), 600+i*700));
  // audio/cam
  setupRecognition(); if(recognizer){ try{recognizer.start();}catch(e){} }
  await setupMicAnalyser(); await setupCam();
  startTimer();
}
function stopSim(){
  if(!running) return; running=false;
  startBtn.disabled=false; stopBtn.disabled=true; downloadBtn.disabled=false;
  stopTimer();
  if(recognizer){ try{ recognizer.stop(); }catch(e){} }
  if(micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream=null; }
  if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null; }
  generateReport();
  showToast('ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± âœ”ï¸');
}

/* ========== ØªÙ‚Ø±ÙŠØ± PDF ========== */
function generateReport(){
  const mins = Math.max(0.01,(Date.now()-startTime)/60000);
  const avgWpm = Math.round(wordsSpoken/mins);
  const intr = interruptions;
  const eye = eyeContactArr.length? Math.round(100*eyeContactArr.reduce((a,b)=>a+b,0)/eyeContactArr.length): null;

  repWpm.textContent = isFinite(avgWpm)?avgWpm:0;
  repIntr.textContent = intr;
  repEye.textContent = (eye!==null?eye+'%':'â€”');

  const strengths=[], improvements=[], tips=[];
  if(avgWpm>=110 && avgWpm<=150) strengths.push('ÙˆØªÙŠØ±Ø© Ù…Ù†Ø§Ø³Ø¨Ø© ØªØ³Ù‡Ù‘Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.');
  if((eye??0)>60) strengths.push('Ø§ØªØµØ§Ù„ Ø¨ØµØ±ÙŠ Ø¬ÙŠØ¯ ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªØ¨Ø§Ù‡.');
  if(intr<=2) strengths.push('ØªØ­ÙƒÙ‘Ù… Ø¬ÙŠØ¯ Ø¨Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹Ø§Øª.');
  if(avgWpm<95) improvements.push('Ø§Ø±ÙØ¹ Ø§Ù„ÙˆØªÙŠØ±Ø© Ù‚Ù„ÙŠÙ„Ù‹Ø§ ÙˆØ£Ø¯Ø®Ù„ Ø£Ù…Ø«Ù„Ø© Ù‚ØµÙŠØ±Ø©.');
  if(avgWpm>165) improvements.push('Ø®ÙÙ‘Ù Ø§Ù„Ø³Ø±Ø¹Ø© ÙˆØªÙˆÙ‚Ù‘Ù Ù„Ø­Ø¸Ø§Øª Ù„Ù„Ø£Ø³Ø¦Ù„Ø©.');
  if((eye??0)<40) improvements.push('ÙˆØ§Ø¬Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø£ÙƒØ«Ø± ÙˆØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ…Ø±ÙƒØ².');
  if(intr>2) improvements.push('Ø¶Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ ØªÙØ§Ø¹Ù„ ÙˆØ§Ø¶Ø­Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡.');

  (currentScenario.students||[]).slice(0,4).forEach(s=>{
    if(s.role.includes('Ù…Ø´Ø§ØºØ¨')) tips.push('Ø­ÙˆÙ‘Ù„ Ø§Ù„Ù…Ø²Ø§Ø­ Ù„Ù†Ù‚Ø·Ø© ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø«Ù… ÙˆØ¬Ù‘Ù‡ Ø³Ø¤Ø§Ù„Ù‹Ø§ Ù…Ø­Ø¯Ø¯Ù‹Ø§.');
    else if(s.role.includes('ÙØ¶ÙˆÙ„ÙŠ')) tips.push('Ø§ØªØ¨Ø¹ Ø¥Ø·Ø§Ø± (ØªØ¹Ø±ÙŠÙ-Ù…Ø«Ø§Ù„-ØªØ·Ø¨ÙŠÙ‚) ÙˆØ­Ø¯Ù‘Ø¯ ÙˆÙ‚Øª Ø£Ø³Ø¦Ù„Ø© Ù…ØªÙ‚Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©.');
    else if(s.role.includes('Ø®Ø¬ÙˆÙ„')) tips.push('Ø£Ø¹Ø·Ù‡ ÙˆÙ‚Øª ØªÙÙƒÙŠØ± ÙˆØ®ÙŠØ§Ø±Ø§Øª Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ø§Ù„Ø´Ø§Øª.');
    else if(s.role.includes('Ù…Ù†Ø´ØºÙ„')) tips.push('Ø¬Ø²Ù‘Ø¦ Ø§Ù„Ø´Ø±Ø­ Ù…Ø¹ Ø£Ø³Ø¦Ù„Ø© ØªØ­Ù‚Ù‚ ÙƒÙ„ 3â€“4 Ø¯Ù‚Ø§Ø¦Ù‚.');
  });

  repStrengths.innerHTML = strengths.map(x=>`<li>${x}</li>`).join('') || '<li>â€”</li>';
  repImprovements.innerHTML = improvements.map(x=>`<li>${x}</li>`).join('') || '<li>â€”</li>';
  repTips.innerHTML = tips.map(x=>`<li>${x}</li>`).join('') || '<li>â€”</li>';

  downloadBtn.onclick = ()=>downloadPDF({
    scenario: scenarioSel.value,
    duration: fmtTime(Date.now()-startTime),
    wpm: avgWpm,
    intr,
    eye,
    rms: rmsLevel,
    pitch: pitchHz?Math.round(pitchHz):null,
    silence: silenceRatio,
    strengths, improvements, tips
  });
}
function downloadPDF(data){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt',format:'a4'});
  let y=50;
  doc.setFont('helvetica','bold'); doc.setFontSize(16);
  doc.text('ØªÙ‚Ø±ÙŠØ± Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù…Ø¯Ø±Ù‘Ø¨', 50, y); y+=22;
  doc.setFont('helvetica','normal'); doc.setFontSize(11);
  doc.text(`Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ: ${data.scenario}`, 50, y); y+=14;
  doc.text(`Ø§Ù„Ù…Ø¯Ø©: ${data.duration}`, 50, y); y+=20;

  doc.setFont('helvetica','bold'); doc.text('Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª:', 50, y); y+=14;
  doc.setFont('helvetica','normal');
  doc.text(`Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø±Ø¹Ø©: ${data.wpm} wpm`, 62, y); y+=12;
  doc.text(`Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹Ø§Øª: ${data.intr}`, 62, y); y+=12;
  doc.text(`Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø¨ØµØ±ÙŠ: ${data.eye??'â€”'}%`, 62, y); y+=12;
  doc.text(`RMS (ØªÙ‚Ø±ÙŠØ¨ÙŠ): ${data.rms}`, 62, y); y+=12;
  doc.text(`Pitch (Hz): ${data.pitch??'â€”'}`, 62, y); y+=12;
  doc.text(`Ø§Ù„ØµÙ…Øª: ${data.silence}%`, 62, y); y+=18;

  const addList=(title,arr)=>{
    doc.setFont('helvetica','bold'); doc.text(title, 50, y); y+=14;
    doc.setFont('helvetica','normal');
    if(!arr.length){ doc.text('â€”', 62, y); y+=12; return; }
    arr.forEach(t=>{ doc.text('â€¢ '+t, 62, y); y+=12; });
    y+=8;
  };
  addList('Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©', data.strengths);
  addList('Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ­Ø³ÙŠÙ†', data.improvements);
  addList('ØªÙˆØµÙŠØ§Øª Ù…ÙˆØ¬Ù‘Ù‡Ø©', data.tips);

  doc.save('trainer-simulation-report.pdf');
}

/* ========== Ø£Ø­Ø¯Ø§Ø« ========== */
document.getElementById('fakeLogin').onclick = ()=>showToast('Ø¯Ø®ÙˆÙ„ Ø¶ÙŠÙ âœ…');
startBtn.onclick = startSim;
stopBtn.onclick = stopSim;

/* ========== Ø¯Ø®ÙˆÙ„ Ø³Ø±ÙŠØ¹ ========== */
function init(){
  // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª
  loadScenarios();
  // ÙƒØ§Ù…/Ù…Ø§ÙŠÙƒ ØªØ­Ø°ÙŠØ±
  if(location.protocol!=='https:' && location.hostname!=='localhost'){
    showToast('ÙŠÙØ¶Ù„ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± HTTPS Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ø§ÙŠÙƒ/Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.');
  }
}
init();
</script>

<footer>
  Ù‡Ø°Ø§ Ù…Ù„Ù ÙˆØ§Ø­Ø¯ (HTML+CSS+JS) â€” Ø¬Ø§Ù‡Ø² Ù„Ù„Ø±ÙØ¹ Ø¹Ù„Ù‰ GitHub Pages. Ø¨Ø§Ù„ØªÙˆÙÙŠÙ‚! âœ…
</footer>
</body>
</html>
